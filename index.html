<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="None">
        
        
        <link rel="shortcut icon" href="./img/favicon.ico">
        <title>StarChat Documentation</title>
        <link href="./css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="./css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="./css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="./css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
	
	<script src="./js/jquery-1.10.2.min.js"></script>
        <script src="./js/bootstrap-3.0.3.min.js"></script>
        <script src="./js/highlight.pack.js"></script> 
    </head>

    <body class="homepage">

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href=".">StarChat Documentation</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li class="active">
                        <a href=".">Home</a>
                    </li>
                    <li >
                        <a href="apis/">APIs</a>
                    </li>
                    <li >
                        <a href="about/">About</a>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li class="disabled">
                        <a rel="next" >
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="apis/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#welcome">Welcome!</a></li>
        <li class="main "><a href="#how-to-contribute">How to contribute</a></li>
        <li class="main "><a href="#quick-start">Quick Start</a></li>
            <li><a href="#requirements">Requirements</a></li>
            <li><a href="#setup-with-docker-recommended">Setup with Docker (recommended)</a></li>
            <li><a href="#install-without-docker">Install without Docker</a></li>
            <li><a href="#install-local-docker-for-testing-branches">Install local Docker (for testing branches)</a></li>
            <li><a href="#test-the-installation">Test the installation</a></li>
            <li><a href="#configuration-of-the-chatbot-decision-table">Configuration of the chatbot (Decision Table)</a></li>
            <li><a href="#nlp-processing">NLP processing</a></li>
            <li><a href="#analyzer">Analyzer</a></li>
            <li><a href="#configuration-of-the-answer-recommender-knowledge-base">Configuration of the answer recommender (Knowledge Base)</a></li>
            <li><a href="#manaus">Manaus</a></li>
        <li class="main "><a href="#technology">Technology</a></li>
            <li><a href="#how-does-starchat-work">How does StarChat work?</a></li>
            <li><a href="#configuration-of-the-decisiontable">Configuration of the DecisionTable</a></li>
            <li><a href="#client-functions">Client functions</a></li>
            <li><a href="#mechanics">Mechanics</a></li>
            <li><a href="#scalability">Scalability</a></li>
            <li><a href="#security">Security</a></li>
        <li class="main "><a href="#indexing-terms-on-term-table">Indexing terms on term table</a></li>
        <li class="main "><a href="#test">Test</a></li>
            <li><a href="#unit-tests">Unit tests</a></li>
            <li><a href="#test-scripts-with-sample-api-calls">test scripts with sample API calls</a></li>
        <li class="main "><a href="#troubleshooting">Troubleshooting</a></li>
            <li><a href="#docker-start-from-scratch">Docker: start from scratch</a></li>
            <li><a href="#docker-compose-analyzers-are-not-loaded">docker-compose: Analyzers are not loaded</a></li>
            <li><a href="#docker-size-of-virtual-memory">Docker: Size of virtual memory</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="welcome">Welcome!</h1>
<p>This is the official repository for StarChat --an Open Source, scalable conversational engine for B2B applications. You can find the code on our <a href="https://github.com/GetJenny/starchat">github repository</a>.</p>
<h1 id="how-to-contribute">How to contribute</h1>
<p>To contribute to StarChat, please send us a <a href="https://help.github.com/articles/using-pull-requests/#fork--pull">pull request</a>  from your fork of this repository.</p>
<p>Our concise <a href="https://github.com/GetJenny/starchat/blob/master/CONTRIBUTING.md">contribution guideline</a> contains the bare
minumum requirements of the code contributions.</p>
<p>Before contributing (or opening issues), you might want send us an email at starchat@getjenny.com.</p>
<h1 id="quick-start">Quick Start</h1>
<h2 id="requirements">Requirements</h2>
<p>The easiest way is to install StarChat using two docker images. You only need:</p>
<ul>
<li><a href="http://www.scala-sbt.org">sbt</a></li>
<li><a href="https://docs.docker.com/engine/installation/">docker</a></li>
<li><a href="https://docs.docker.com/compose/install/">docker compose</a></li>
</ul>
<p>In this way, you will put all the indices in the Elasticsearch (version 6.1) image, and StarChat itself in the Java (8) image.</p>
<p><em>If you do not use docker</em> you therefore need on your machine:</p>
<ol>
<li><a href="http://scala-lang.org">Scala 12.2</a></li>
<li><a href="http://elastic.co">Elasticsearch 5.4</a></li>
</ol>
<h2 id="setup-with-docker-recommended">Setup with Docker (recommended)</h2>
<h3 id="1-launch-docker-containers">1. Launch Docker containers</h3>
<p>We have made available all the containers needed for having StarChat up and running without local compiling.</p>
<p>To use them, you need to download <a href="https://github.com/GetJenny/starchat-docker">Starchat Docker</a> or simply type:</p>
<pre><code class="bash">git clone git@github.com:GetJenny/starchat-docker.git
</code></pre>

<p>Now just type:</p>
<pre><code class="bash">docker-compose up -d
</code></pre>

<p>And you will have a running instance on port 8888. (If you want to change ports, go to <code>starchat-docker/starchat/config/application.conf</code>)</p>
<p>(Problems like <code>elastisearch exited with code 78</code>? have a look at <a href="#troubleshooting">troubleshooting</a>!)</p>
<h4 id="change-manaus-language">Change Manaus Language</h4>
<p>In the file <code>docker-compose.yml</code> change:</p>
<pre><code class="json">    command: [&quot;/manaus/scripts/wait-for-it.sh&quot;, 
    &quot;getjenny-es&quot;, &quot;9200&quot;, &quot;5&quot;, 
    &quot;/manaus/bin/continuous-keywords-update&quot;, &quot;--temp_data_folder&quot;, 
    &quot;/manaus/data&quot;, 
    &quot;--host_map&quot;, &quot;getjenny-es=9300&quot;, &quot;--interval_sec&quot;, &quot;14400&quot;, 
    &quot;--word_frequencies&quot;, 
    &quot;/manaus/statistics_data/english/word_frequency.tsv&quot;, 
    &quot;--cluster_name&quot;, &quot;starchat&quot;, &quot;--index_name&quot;, &quot;jenny-en-0&quot;]
</code></pre>

<p>to</p>
<pre><code class="json">    command: [&quot;/manaus/scripts/wait-for-it.sh&quot;, 
    &quot;getjenny-es&quot;, &quot;9200&quot;, &quot;5&quot;, 
    &quot;/manaus/bin/continuous-keywords-update&quot;, &quot;--temp_data_folder&quot;, 
    &quot;/manaus/data&quot;, 
    &quot;--host_map&quot;, &quot;getjenny-es=9300&quot;, &quot;--interval_sec&quot;, &quot;14400&quot;, 
    &quot;--word_frequencies&quot;, &quot;/manaus/statistics_data/***italian***/word_frequency.tsv&quot;, 
    &quot;--cluster_name&quot;, &quot;starchat&quot;, &quot;--index_name&quot;,  &quot;***jenny-it-0***&quot;]
</code></pre>

<h3 id="2-create-elasticsearch-indices">2. Create Elasticsearch indices</h3>
<p>Run from a terminal:</p>
<pre><code class="bash"># create the system indices in Elasticsearch
PORT=${1:-8888}
curl -v -H &quot;Authorization: Basic `echo -n 'admin:adminp4ssw0rd' | base64`&quot; \
  -H &quot;Content-Type: application/json&quot; -X POST &quot;http://localhost:${PORT}/system_index_management/create&quot;
</code></pre>

<p>If you are using another language than English, replace english in the name of the index:</p>
<pre><code class="bash"># create the application indices on Elasticsearch
PORT=${1:-8888}
INDEX_NAME=${2:-index_english_0}
curl -v -H &quot;Authorization: Basic `echo -n 'admin:adminp4ssw0rd' | base64`&quot; \
  -H &quot;Content-Type: application/json&quot; -X POST &quot;http://localhost:${PORT}/${INDEX_NAME}/index_management/create&quot;
</code></pre>

<pre><code class="bash"># add a user to the system associated to the application index index_english_0 previously created
PORT=${1:-8888}
curl -v -H &quot;Authorization: Basic `echo -n 'admin:adminp4ssw0rd' | base64`&quot; \
  -H &quot;Content-Type: application/json&quot; -X POST http://localhost:${PORT}/user -d '{
        &quot;id&quot;: &quot;test_user&quot;,
        &quot;password&quot;: &quot;3c98bf19cb962ac4cd0227142b3495ab1be46534061919f792254b80c0f3e566f7819cae73bdc616af0ff555f7460ac96d88d56338d659ebd93e2be858ce1cf9&quot;, 
        &quot;salt&quot;: &quot;salt&quot;,
        &quot;permissions&quot;: {
                &quot;index_english_0&quot;: [&quot;read&quot;, &quot;write&quot;]
        }
}'
</code></pre>

<h3 id="3-load-the-configuration-file">3. Load the configuration file</h3>
<p>Now you have to load the configuration file for the actual chat, aka <a href="#services">decision table</a>. We have provided an <a href="https://github.com/GetJenny/starchat/tree/master/doc">example configuration file in English</a>, therefore:</p>
<pre><code class="bash">cd $STARCHAT  # so we have doc/decision_table_starchat_doc.csv
PORT=${1:-8888}
INDEX_NAME=${2:-'index_english_0'}
FILENAME=${3:-&quot;`readlink -e doc/decision_table_starchat_doc.csv`&quot;}
curl -v -H &quot;Authorization: Basic `echo -n 'test_user:p4ssw0rd' | base64`&quot; \
  --form &quot;csv=@${FILENAME}&quot; http://localhost:8888/${INDEX_NAME}/decisiontable_upload_csv
</code></pre>

<p>and then you need to index the analyzer:</p>
<pre><code class="bash">PORT=${1:-8888}
INDEX_NAME=${2:-index_english_0}
curl -v -H &quot;Authorization: Basic `echo -n 'test_user:p4ssw0rd' | base64`&quot; \
  -H &quot;Content-Type: application/json&quot; -X POST &quot;http://localhost:${PORT}/${INDEX_NAME}/decisiontable_analyzer&quot;
</code></pre>

<p>In case you want to delete all states previously loaded, this endpoint deletes all the states:</p>
<pre><code class="bash">PORT=${1:-8888}
INDEX_NAME=${2:-index_english_0}
curl -v -H &quot;Authorization: Basic `echo -n 'test_user:p4ssw0rd' | base64`&quot; \
  -H &quot;Content-Type: application/json&quot; -X DELETE http://localhost:${PORT}/${INDEX_NAME}/decisiontable
</code></pre>

<h3 id="4-load-external-corpus-optional">4. Load external corpus (optional)</h3>
<p>To have a good words' statistics, and consequent improved matching, you might want to index a corpus which is hidden from results. For instance, you can index various sentences as hidden using the <a href="#post-knowledgebase">POST /knowledgebase</a> endpoint with <code>doctype: "hidden"</code>.</p>
<h3 id="5-index-the-faqs-optional">5. Index the FAQs (optional)</h3>
<p>TODO: You might want to activate the <a href="#configuration-of-the-answer-recommender-knowledge-base">knowledge base</a> for simple Question and Anwer. </p>
<h2 id="install-without-docker">Install without Docker</h2>
<p>Note: we do not support this installation.</p>
<ul>
<li>Clone the repository and enter the starchat directory.</li>
<li>Initialize the Elasticsearch instance (see above for Docker)</li>
<li>Run the service: <code>sbt compile run</code></li>
</ul>
<p>The service binds on the port 8888 by default.</p>
<h2 id="install-local-docker-for-testing-branches">Install local Docker (for testing branches)</h2>
<p>Generate a packet distribution. In StarChat directory:</p>
<pre><code class="bash">sbt dist
</code></pre>

<p>Enter the directory docker-starchat:</p>
<pre><code class="bash">cd  docker-starchat
</code></pre>

<p>You will get a message like <code>Your package is ready in ...../target/universal/starchat-4ee.... .zip</code>.  Extract the packet into the docker-starchat folder:</p>
<pre><code class="bash">unzip ../target/universal/starchat-4eee.....zip
ln -s starchat-4ee..../  starchat
</code></pre>

<p>The zip packet contains:</p>
<ul>
<li>a set of scripts to test the endpoints and as a complement for the documentation: <code>starchat/scripts/api_test/</code></li>
<li>a set of command line programs <code>starchat/bin</code> to run starchat and other tools.</li>
<li>delete-decision-table: application to delete items from the decision table</li>
<li>index-corpus-on-knowledge-base: application to index a corpus on knowledge base as hidden (to improve the language model)</li>
<li>index-decision-table: application to index data on the decision table from a csv</li>
<li>index-knowledge-base: application to index data into the knowledge base</li>
<li>index-terms: application to index terms vectors</li>
<li>starchat: start starchat</li>
</ul>
<p>Review the configuration files <code>starchat/config/application.conf</code> and configure the language if needed (by default you have <code>index_language = "english"</code>)</p>
<p>(If you are re-installing StarChat, and want to start from scratch see <a href="#docker-start-from-scratch">start from scratch</a>.)</p>
<p>Start both startchat and elasticsearch:</p>
<pre><code class="bash">docker-compose up -d
</code></pre>

<p>(Problems like <code>elastisearch exited with code 78</code>? have a look at <a href="#troubleshooting">troubleshooting</a>!)</p>
<h2 id="test-the-installation">Test the installation</h2>
<p>Is the service working? But first: <em>did you load a configuration file</em>? If yes, try:</p>
<p><code>curl -X GET localhost:8888 | python -mjson.tool</code></p>
<p>Get the <code>test_state</code></p>
<pre><code class="bash">PORT=${2:-8888}
INDEX_NAME=${3:-index_english_0}
curl -v -H &quot;Authorization: Basic `echo -n 'test_user:p4ssw0rd' | base64`&quot; \
 -H &quot;Content-Type: application/json&quot; -X POST http://localhost:${PORT}/${INDEX_NAME}/get_next_response -d '{
 &quot;conversation_id&quot;: &quot;1234&quot;,
  &quot;user_input&quot;: { &quot;text&quot;: &quot;install starchat&quot; },
  &quot;values&quot;: {
      &quot;return_value&quot;: &quot;&quot;,
      &quot;data&quot;: {}
       }
  }'
</code></pre>

<p>You should get:</p>
<pre><code class="json">[
   {
      &quot;state&quot; : &quot;install&quot;,
      &quot;data&quot; : {},
      &quot;action&quot; : &quot;&quot;,
      &quot;success_value&quot; : &quot;&quot;,
      &quot;state_data&quot; : {},
      &quot;score&quot; : 1,
      &quot;conversation_id&quot; : &quot;1234&quot;,
      &quot;traversed_states&quot; : [
         &quot;install&quot;
      ],
      &quot;max_state_count&quot; : 0,
      &quot;action_input&quot; : {},
      &quot;analyzer&quot; : &quot;band(bor(keyword(\&quot;setup\&quot;), keyword(\&quot;install.*\&quot;)), bnot(bor(keyword(\&quot;standalone\&quot;), keyword(\&quot;docker\&quot;))))&quot;,
      &quot;bubble&quot; : &quot;Just choose one of the two:\n&lt;ul&gt;\n&lt;li&gt;docker install (recommended)&lt;/li&gt;\n&lt;li&gt;standalone install&lt;/li&gt;\n&lt;/ul&gt;&quot;,
      &quot;failure_value&quot; : &quot;&quot;
   }
]
</code></pre>

<p>If you look at the <code>"analyzer"</code> field, you'll see that this state is triggered when
the user types the <em>test</em> and either <em>get</em> or <em>send</em>. Try with <code>"text": "Please dont send me the test state"</code>
 and StarChat will send an empty message.</p>
<h2 id="configuration-of-the-chatbot-decision-table">Configuration of the chatbot (Decision Table)</h2>
<p>With StarChat's Decision Table you can easily implement workflow-based chatbots. After the installation (see above)
you only have to configure a conversation flow and eventually a front-end client.</p>
<h2 id="nlp-processing">NLP processing</h2>
<p>NLP processing is of course the core of any chatbot. As you have noted in the  <a href="https://github.com/GetJenny/starchat/blob/master/doc/sample_state_machine_specification.csv">CSV provided in the doc/ directory</a> there are two fields defining when StarChat should trigger a state -<code>analyzer</code> and <code>queries</code>.</p>
<h3 id="queries">Queries</h3>
<p>If the <code>analyzer</code> field is empty, StarChat will query Elasticsearch for the state containing the most similar sentence in the field <code>queries</code>. We have carefully configured Elasticsearch in order to provide good answers (e.g. boosting results where the same words appear etc), and results are... acceptable. But you are encouraged to use the <code>analyzer</code> field, documented below.</p>
<h2 id="analyzer">Analyzer</h2>
<p>The <code>analyzers</code> are a Domain Specific Language which allow to put together various functions using logical operators.</p>
<p>Through the <code>analyzers</code>, you can leverage on various NLP algorithms included in StarChat and combine the results of those algorithms with other rules. For instance you might want to get into the state which asks for the email only if a variable "email" is not set. Or you want to escalate to a human operator after you detect swearing for three times. Or you want to escalate only on working days. You can do all that with the <code>analyzers</code>.</p>
<p>We can have a look at the simple example included in the  <a href="https://github.com/GetJenny/starchat/blob/master/doc/sample_state_machine_specification.csv">CSV provided in the doc/ directory</a> for the state <code>forgot_password</code>:</p>
<pre><code>booleanAnd(keyword(&quot;password&quot;),booleanOr(keyword(&quot;reset&quot;),keyword(&quot;forgot&quot;)))
</code></pre>

<p>The analyzer above says the state must be triggered if the term "password" is detected together with either "reset" or "forgot".</p>
<p>Another example. Imagine we have a state called <code>send-updates</code>. In this state StarChat proposes the question "Where can we send you updates?". In the config file:</p>
<pre><code>state           | ... | bubble                              | ...
send-updates    | ... | &quot;Where can we send you updates?&quot;    |
</code></pre>

<p>In another state, called <code>send-email</code>, we have the anlyzer field with:</p>
<pre><code>booleanAnd(lastTravStateIs(&quot;send-updates&quot;), matchEmailAddress(&quot;verification_&quot;))
</code></pre>

<p>this means <code>send-email</code> will be triggered only after <code>send-updates</code> (because of <code>lastTravStateIs</code>) <em>and</em> if an email address is detected (because of <code>matchEmailAddress</code>). This will also set the variable <code>verification_email</code> because the expression <code>matchEmailAddress</code> in case of success always sets such variable, with the expression's argument as prefix.</p>
<p>In addition to that, the expression <code>sendVerificationEmail</code> could be developed (we haven't) which accepts others arguments, for example:</p>
<p><code>sendVerificationEmail("verification_", "Email about Verification", "Here is your verification link %__temp__verification_link%)</code></p>
<p>In this case, the expression would </p>
<ul>
<li>extract an email address from the user's query</li>
<li>set a variable <code>verification_email</code> with such address</li>
<li>retrieve a verification link from some API </li>
<li>put that link into the temporary variable <code>__temp__verification_link</code>. </li>
<li>send an email with subject "Email about Verification" and body "Here is your..."</li>
<li>return 1 in case of success</li>
</ul>
<p><strong>TODO</strong> It is fundamental here to build a set of metadata which allows any other component to receive all needed information about the analyzer. For instance, the <code>sendVerificationEmail</code> could have something like:</p>
<pre><code class="json">[
    &quot;documentation&quot;: &quot;Send an email with subject and body. If successful returns 1.0 and sets the variables. If not returns 0 and does not set the variables.&quot;
    &quot;argument_list&quot;: [&quot;'prefix' of the variable 'prefix_email'&quot;, 
                      &quot;Subject of the email to be sent&quot;, &quot;Body of the mail&quot;],
    &quot;created_variables&quot;: {  // Variables it creates
        &quot;__temp__verification_link&quot;: &quot;Link provided by the brand's API&quot;, //will after usage because starts with __temp__
        &quot;prefix_email&quot;: &quot;email address&quot;
        },
    &quot;used_variables&quot;: {  // Variables it expects to find in the state (none here)
        }

</code></pre>

<h3 id="how-the-analyzers-are-organized">How the <code>analyzers</code> are organized</h3>
<p>The <code>analyzer</code> DSL building blocks are the <em>expression</em>. For instance, 
<code>or</code>, <code>and</code>, <code>keyword</code> are all <em>expressions</em>. </p>
<p>Espressions are then divided into <em>operators</em> (<code>or</code>...) and <em>atoms</em> (<code>keyword</code>).</p>
<h3 id="expressions-atoms">Expressions: Atoms</h3>
<p>Presently, the <code>keyword("reset")</code> in the example provides a very simple score: occurrence of the word <em>reset</em> in the user's query divided by the total number of words. If evaluated agains the sentence "Want to reset my password", <code>keyword("reset")</code> will currently return 0.2.  </p>
<p><strong>TODO</strong>: This is just a temporary score used while our NLP library <a href="https://github.com/GetJenny/manaus">manaus</a> is not integrated into the decision table.</p>
<p>These are currently the expression you can use to evaluate the goodness of a query (see <a href="https://github.com/GetJenny/starchat/blob/master/src/main/scala/com/getjenny/analyzer/atoms/DefaultFactoryAtomic.scala">DefaultFactoryAtomic</a> and <a href="https://github.com/GetJenny/starchat/blob/master/src/main/scala/com/getjenny/starchat/analyzer/atoms/StarchatFactoryAtomic.scala">StarchatFactoryAtomic</a>:</p>
<ul>
<li><em>keyword("pass.*")</em>: as explained above, detects any word starting with "pass". Normalized.</li>
<li><em>regex(regex)</em>: evaluate a regular expression, not normalized</li>
<li><em>search(state-name)</em>: take a state name as argument, queries elastic search and returns the score of the most similar query in the field  <code>queries</code> of the argument's state. In other words, it does what it would do without any analyzer, only with a normalized score -e.g. <code>search("lost_password_state")</code> </li>
<li><em>matchPatternRegex(regex)</em>: A generic pattern extraction analyzer, it extract named patterns matching a given regex e.g. the following will match tree numbers separated by semicolumn: [first,second,third](?:([0-9]+:[0-9]:[0-9]+) if the regex matches it will create the entries into the state variables dictionary e.g.: 10:11:12 will result in Map("first.0" -&gt; "10", "second.0" -&gt; "11", "third.0" -&gt; "12") the number at the end of the name is an index incremented for multiple occurrences of the pattern in the query</li>
<li><em>matchDateDDMMYYYY(prefix)</em>: parse a date in DDMMYYYY format and set <code>prefixday.0</code>, <code>prefixmonth.0</code>, <code>prefixyear.0</code>.</li>
<li><em>existsVariable(variable-name)</em>: check whether a variable exists or not </li>
<li><em>hasTravState(state-name)</em>: check if a state_name is present into the history of traversed states</li>
<li><em>lastTravStateIs(state-name)</em>: check if the last traversed state is state_name</li>
<li><em>prevTravStateIs(state-name)</em>: check if the last but one traversed state is state_name</li>
<li><em>distance("forget.<em>", ..., "pass.</em>")</em>: score based on the (cosine) distance between the query and the list of words in the argument. </li>
</ul>
<!--Only if you have loaded a Word2Vec model:

* _synonym("word")_: gives a normalized cosine distance between the argument and the closest word in the user's sentence. We use word2vec, to have an idea of two words distance you can use this [word2vec demo](http://bionlp-www.utu.fi/wv_demo/) by [Turku University](http://bionlp.utu.fi/)
* _similar("a whole sentence")_:  gives a normalized cosine distance between the argument and the closest word in the user's sentence (word2vec)
* _similarState(state-name)_ :  same as above, but for the sentences in the field "queries" of the state in the argument.
* _similarEucEmd("a whole sentence")_: gives a non-normalized euclidean distance (calculated using the earth movers distance algorithm) between the argument and the closest sentence in the user's sentence (word2vec)
* _similarEucEmdState(state-name)_: same as above, but for the sentences in the field "queries" of the state in the argument.
* _similarCosEmd("a whole sentence")_: gives a normalized cosine distance (calculated using the earth movers distance algorithm) between the argument and the closest sentence in the user's sentence (word2vec)
* _similarCosEmdState(state-name)_: same as above, but for the sentences in the field "queries" of the state in the argument.

-->

<h3 id="expressions-operators">Expressions: Operators</h3>
<p>Operators evaluate the output of one or more expression and return a value. Currently, the following operators are implemented (the the <a href="https://github.com/GetJenny/starchat/blob/master/src/main/scala/com/getjenny/analyzer/operators/DefaultFactoryOperator.scala">source code</a>):</p>
<ul>
<li><em>boolean or</em>:   calles matches of all the exprassions it contains and returns true or false. It can be called using <code>bor</code></li>
<li><em>boolean and</em>:  as above, it's called with <code>band</code></li>
<li><em>boolean not</em>:  ditto, <code>bnot</code></li>
<li><em>conjunction</em>:  if the evaluation of the expressions it contains is normalized, and they can be seen as probabilities of them being true, this is the probability that all the expressions are all true (<code>P(A)*P(B)</code>)</li>
<li><em>disjunction</em>:  as above, the probability that at least one is true (<code>1-(1-P(A))*(1-P(B))</code>)</li>
<li><em>max</em>: takes the max score of returned by the expression arguments</li>
</ul>
<h3 id="technical-corner-expressions">Technical corner: <code>expressions</code></h3>
<p><a href="https://github.com/GetJenny/starchat/blob/master/src/main/scala/com/getjenny/analyzer/expressions/Expression.scala">Expressions</a>, like <a href="https://github.com/GetJenny/starchat/blob/master/src/main/scala/com/getjenny/analyzer/atoms/KeywordAtomic.scala#L18">keywords</a> in the example, are called <a href="https://github.com/GetJenny/starchat/blob/master/src/main/scala/com/getjenny/analyzer/atoms/AbstractAtomic.scala">atoms</a>, and have the following methods/members:</p>
<ol>
<li><code>def evaluate(query: String): Double</code>: produce a score. It might be normalized to 1 or not (set <code>val isEvaluateNormalized: Boolean</code> accordingly)</li>
<li><code>val match_threshold</code> This is the threshold above which the expression is considered true when <code>matches</code> is called. NB The default value is 0.0, which is normally not ideal.</li>
<li><code>def matches(query: String): Boolean</code>: calles evaluate and check agains the threshold...</li>
<li><code>val rx</code>: the name of the atom, as it should be used in the <code>analyzer</code> field.</li>
</ol>
<h2 id="configuration-of-the-answer-recommender-knowledge-base">Configuration of the answer recommender (Knowledge Base)</h2>
<p>Through the <a href="https://getjenny.github.io/starchat-doc/apis/#get-knowledgebase">/knowledgebase</a> endpoint
you can add, edit and remove pairs of question and answers used by StarChat to recommend possible answers when a question arrives.</p>
<p>Documents containing Q&amp;A must be structured like that:</p>
<pre><code class="json">{
    &quot;id&quot;: &quot;0&quot;,  // id of the pair
    &quot;conversation&quot;: &quot;id:1000&quot;,   // id of the conversation. This can be useful to external services
    &quot;index_in_conversation&quot;: 1,  // when the pair appears inside the conversation, as above
    &quot;question&quot;: &quot;thank you&quot;,  // The question to be matched
    &quot;answer&quot;: &quot;you are welcome!&quot;,  // The answer to be recommended 
    &quot;question_scored_terms&quot;: [  // A list of keyword and score. You can use your own keyword extractor or our Manaus (see later)
        [
            &quot;thank&quot;, 
            1.9
        ]
    ],
    &quot;verified&quot;: true,  // A variable used in some call centers
    &quot;topics&quot;: &quot;t1 t2&quot;,  // Eventual topics to be associated
    &quot;dclass&quot;: &quot;&quot;, // Optional field as a searchable class for answer
    &quot;doctype&quot;: &quot;normal&quot;,
    &quot;state&quot;: &quot;&quot;,
    &quot;status&quot;: 0
}
</code></pre>

<p>See <a href="https://getjenny.github.io/starchat-doc/apis/#post-knowledgebase">POST /knowledgebase</a> for an example with <code>curl</code>. Other calls (<code>GET, DELETE, PUT</code>) are used to get the state, delete it or update it. </p>
<h3 id="test-the-knowledge-base">Test the knowledge base</h3>
<p>Just run the example in <a href="https://getjenny.github.io/starchat-doc/apis/#knowledgebase_search">POST /knowledgebase_search</a>.</p>
<h2 id="manaus">Manaus</h2>
<p>In the Q&amp;A pair above you saw the field
<code>question_scored_terms</code>. Having good keywords improves enormously the
quality of the answer. You can of course put them by hand, or run a
software which extracts the keywords from the question. If you prefer
the latter, but don't have any, we provide
<a href="https://github.com/GetJenny/manaus">Manaus</a>.</p>
<p>Manaus is still under development, but it's already included in the
Docker's installation of StarChat. When you launch <code>docker-compose up
-d</code>, you also launch a container with Manaus which analyzes all the
Q&amp;A in the Knowledge Base, produces keywords and updates the field
question_scored_terms for all documents. The process is repeated evert
4 hour.</p>
<h3 id="manaus-configuration">Manaus configuration</h3>
<p>Have a look at the file <code>docker-starchat/docker-compose.yml</code>. For
Manaus to have good performance, you need to provide decent language
statistics. Update the file <code>/manaus/statistics_data/english/word_frequency.tsv</code> with a
word-frequency file with the following format:</p>
<pre><code>1       you     1222421
2       I       1052546
3       to      823661
....
</code></pre>

<p>We have frequency file for more than 50 languages, but consider that
the choice of good "prior distribution" of word frequency is crucial
for any NLP task.</p>
<h1 id="technology">Technology</h1>
<p>StarChat was design with the following goals in mind:</p>
<ol>
<li>easy deployment</li>
<li>multi-tenancy: starchat can handle different KnowledBase and DecisionTable configurations </li>
<li>horizontally scalability without any service interruption.</li>
<li>modularity</li>
<li>statelessness</li>
</ol>
<h2 id="how-does-starchat-work">How does StarChat work?</h2>
<h3 id="workflow">Workflow</h3>
<p><img alt="alt tag" src="https://www.websequencediagrams.com/cgi-bin/cdraw?lz=dGl0bGUgc2ltcGxpZmllZCBSZXN0QVBJQ2FsbGluZ01lY2hhbmlzbSBpbiAqQ2hhdAoKVXNlciAtPiBTdGFyY2hhdFJlc291cmNlOiByZXN0IGFwaSBjYWxsIChpbiBqc29uKQoAGhAAKBZqc29uIGRlc2VyaWFsaXphdGlvbiBpbnRvIGVudGl0eQAqHVNlcnZpY2U6AHYFaW5nIGZ1bmMAPQUoaW4AOgcAgH8KACcHACwVADAJZXhlY3V0aW9uABscAIFzCgBoCXJlc3VsdCAob3V0AGgRAIFkHgCBbQ5vZgCBcgcAgX8GamVzAIEACwCCPwxVc2VyAIJyC3Jlc3BvbnNlAHwGAIJ8BgoK&amp;s=napkin" /></p>
<h3 id="components">Components</h3>
<p>StarChat uses Elasticsearch as NoSQL database and, as said above, NLP preprocessor, for
indexing, sentence cleansing, and tokenization.</p>
<h3 id="services">Services</h3>
<p>StarChat consists of the following REST resources. </p>
<h4 id="root">Root</h4>
<p>The root endpoint provides just an health check endpoint</p>
<h3 id="systemindexmanagement">SystemIndexManagement</h3>
<p>The SystemIndexManagement set of endpoints provides a means to set 
up and manage the system tables.</p>
<h3 id="indexmanagement">IndexManagement</h3>
<p>The IndexManagement REST endpoints allows to create new indexes for new instances (StarChat is multitenant).</p>
<h3 id="languageguesser">LanguageGuesser</h3>
<p>Offers endpoints to guess the language given a text.</p>
<h3 id="questionanswer-type-same-api-syntax-and-semantic">QuestionAnswer type (same API syntax and semantic):</h3>
<p>The following REST endpoints have the same syntax and semantic
but they serve different needs.</p>
<h4 id="knowledgebase">KnowledgeBase</h4>
<p>For quick setup based on real Q&amp;A logs. It stores question and answers pairs. Given a text as input
 it proposes the pair with the closest match on the question field.
  At the moment the KnowledBase supports only Analyzers implemented on Elasticsearch.</p>
<h4 id="priordata">PriorData</h4>
<p>The prior data contains text to be used for extraction of statistics about terms and text.
The data are used primarity for terms extraction (Manaus)</p>
<h4 id="conversationlogs">ConversationLogs</h4>
<p>Endpoint to collect and store the conversation logs.</p>
<h3 id="tokenizer">Tokenizer</h3>
<p>Endpoint which exposes text tokenization functionalities.</p>
<h3 id="spellcheck">Spellcheck</h3>
<p>Endpoint which exposes spellcheck functionalities, the terms statistics are taken from the KnowledgeBase.</p>
<h3 id="term">Term</h3>
<p>Endpoint to store informations about terms: synonyms, antonyms and vectorial representation.</p>
<h3 id="termsextraction">TermsExtraction</h3>
<p>Exposes Manaus functionalities to extract significant terms from the text.
It need data from the PriorData and the domain specific dataset (KnowledgeBase).</p>
<h3 id="analyzersplayground">AnalyzersPlayground</h3>
<p>Exposes REST endpoints to test the analyzers on the fly.</p>
<h3 id="decisiontable">DecisionTable</h3>
<p>The conversational engine itself. For the usage, see below.</p>
<h2 id="configuration-of-the-decisiontable">Configuration of the DecisionTable</h2>
<p>You configure the DecisionTable through CSV file. Please have a look at the <a href="https://github.com/GetJenny/starchat/blob/master/doc/sample_state_machine_specification.csv">CSV provided in the doc/ directory</a>.</p>
<p>Fields in the configuration file are of three types:</p>
<ul>
<li><strong>(R)</strong>: Return value: the field is returned by the API</li>
<li><strong>(T)</strong>: Triggers to the state: when should we enter this state? </li>
<li><strong>(I)</strong>: Internal: a field not exposed to the API</li>
</ul>
<p>And the fields are:</p>
<ul>
<li><strong>state</strong>: a unique name of the state (e.g. <code>forgot_password</code>)</li>
<li><strong>execution_order</strong>: specify an order of evaluation for analyzers the lower is the number earlier is the evaluation of the state</li>
<li><strong>max_state_count</strong>: defines how many times StarChat can repropose the state during a conversation.</li>
<li><strong>analyzer (T,I)</strong>: specify an analyzer expression which triggers the state</li>
<li><strong>query (T,I)</strong>: list of sentences whose meaning identify the state</li>
<li><strong>bubble (R)</strong>: content, if any, to be shown to the user. It may contain variables like %email% or %link%.</li>
<li><strong>action (R)</strong>: a function to be called on the client side. StarChat developer must provide types of input and output (like an abstract method), and the GUI developer is responsible for the actual implementation (e.g. <code>show_button</code>)</li>
<li><strong>action_input (R)</strong>: input passed to <strong>action</strong>'s function (e.g., for <code>show_buttons</code> can be a list of pairs <code>("text to be shown on button", state_to_go_when_clicked)</code> </li>
<li><strong>state_data (R)</strong>: a dictionary of strings with arbitrary data to pass along</li>
<li><strong>success_value (R)</strong>: output to return in case of success</li>
<li><strong>failure_value (R)</strong>: output to return in case of failure</li>
</ul>
<h2 id="client-functions">Client functions</h2>
<p>In StarChat configuration, the developer can specify which function the front-end should
execute when a certain state is triggered, together with input parameters.
<strong>Any function implemented on the front-end can be called.</strong></p>
<h3 id="example-show-button">Example show button</h3>
<ul>
<li>Action: <code>show_buttons</code></li>
<li>Action input: <code>{"buttons": [("Forgot Password", "forgot_password"), ("Account locked", "account_locked")]}</code></li>
<li>The frontend will call function: <code>show_buttons(buttons={"Forgot Password": "forgot_password","Account locked": "account_locked")</code></li>
</ul>
<p>Example "buttons": the front-end implements the function show_buttons and uses "action input" to call it. It will show two buttons, where the first returns forgot_password and the second account_locked.</p>
<h3 id="example-send-email">Example send email</h3>
<ul>
<li>Action: <code>send_password_link</code></li>
<li>Action input: <code>{ "template": "Reset your password here: example.com","email": "%email%","subject": "New password" }</code></li>
<li>The frontend will call function: <code>send_password_link(template="Reset your password here: example.com.",email= "john@foo.com", subject="New password")</code></li>
</ul>
<p>Example "send email": the front-end implements the function send_password_link and uses "action input" to call it.
The variable %email% is automatically substituted by the variable email if available in the JSON passed to the
StarchatResource.</p>
<h3 id="functions-for-the-sample-csv">functions for the sample csv</h3>
<p>For the CSV in the example above, the client will have to implement the following set of functions:</p>
<ul>
<li>show_buttons: tell the client to render a multiple choice button</li>
<li>input: a key/value pair with the key indicating the text to be shown in the button, and the value indicating the state to follow e.g.: {"Forgot Password": "forgot_password", "Account locked": "account_locked", "Specify your problem": "specify_problem", "I want to call an operator": "call_operator", "None of the above": "start"}</li>
<li>output: the choice related to the button clicked by the user e.g.: "account_locked"</li>
<li>input_form: render an input form or collect the input following a specific format</li>
<li>input: a dictionary with the list of fields and the type of fields, at least "email" must be supported: e.g.: { "email": "email" } where the key is the name and the value is the type</li>
<li>output: a dictionary with the input values e.g.: { "email": "foo@example.com" }</li>
<li>send_password_generation_link: send an email with instructions to regenerate the password</li>
<li>input: a valid email address e.g.: "foo@example.com"</li>
<li>output: a dictionary with the response fields e.g.: { "user_id": "123", "current_state": "forgot_password", "status": "true" }</li>
</ul>
<p>Ref: <a href="https://github.com/GetJenny/starchat/blob/master/doc/sample_state_machine_specification.csv">sample_state_machine_specification.csv</a>.</p>
<h2 id="mechanics">Mechanics</h2>
<ul>
<li>The client implements the functions which appear in the action field of the spreadsheet. 
We will provide interfaces.</li>
<li>The client call the rest API "decisiontable" endpoint communicating a state if any, 
the user input data and other state variables</li>
<li>The client receive a response with guidance on what to return to the user and what 
are the possible next steps</li>
<li>The client render the message to the user and eventually collect the input, then 
call again the system to get instructions on what to do next</li>
<li>When the "decisiontable" functions does not return any result the user can call the "knowledgebase" endpoint which contains all the conversations. </li>
</ul>
<h2 id="scalability">Scalability</h2>
<p>StarChat consists of two different services: StarChat itself and an Elasticsearch cluster. </p>
<h3 id="scaling-starchat-instances">Scaling StarChat instances</h3>
<p>Since StarChat is stateless it can scale horizontally by replication.
All the instances can access to all the configured indexes on ElasticSearch and can answer to the 
APIs call enforcing authentication and authorization rules. A load balancer will be responsible
of scheduling the requests to the instances transparently.</p>
<p>In the diagram below, a load balancer forward requests coming from the front-end to StarChat instances 
which access to the indices created on the Elasticsearch cluster.</p>
<p><img alt="Image" src="./img/scalability_diagram_starchat.png?raw=true" /></p>
<h3 id="scaling-elasticsearch">Scaling Elasticsearch</h3>
<p>Similarly, Elasticsearch can easily scale horizontally adding new nodes to the cluster, as explained
 in <a href="https://www.elastic.co/guide/en/elasticsearch/guide/master/_scale_horizontally.html">Elasticsearch Documentation</a>.</p>
<h2 id="security">Security</h2>
<p>StarChat is a backend service which supports authentication and authorization with salted SHA512 hashed
password and differentiated permissions.</p>
<p>The admin hashed password and salt are stored on the StarChat configuration file, the user credentials 
(hashed password, salt, permissions) are instead saved on ElasticSearch (further backend for 
authentication/authorization can be implemented by specialization of the Auth. classes).</p>
<p>StarChat support TLS connections, the configuration file allow to
choose if the service should expose an https connection or an http connection
or both.
In order to use the https connection the user must do the following things:</p>
<ul>
<li>obtain a pkcs12 server certificate from a certification authority or <a href="http://typesafehub.github.io/ssl-config/CertificateGeneration.html">create a self signed certificate</a></li>
<li>save the certificate inside the folder <code>config/tls/certs/</code> e.g. <code>config/tls/certs/server.p12</code></li>
<li>set the password for the certificate inside the configuration file</li>
<li>enable the https connection setting to true the https.enable property of the configuration file</li>
<li>optionally disable the http connection setting to false the http.enable property of the configuration file</li>
</ul>
<p>Follows the block of the configuration file which is to be modified as described above in
 order to use https:</p>
<pre><code class="yaml">https {
  host = &quot;0.0.0.0&quot;
  host = ${?HOST}
  port = 8443
  port = ${?PORT}
  certificate = &quot;server.p12&quot;
  password = &quot;uma7KnKwvh&quot;
  enable = false
}

http {
  host = &quot;0.0.0.0&quot;
  host = ${?HOST}
  port = 8888
  port = ${?PORT}
  enable = true
}
</code></pre>

<p>StarChat come with a default self-signed certificate for testing,
using it for production or sensitive environment is highly discouraged
as well as useless from a security point of view.</p>
<h1 id="indexing-terms-on-term-table">Indexing terms on term table</h1>
<p>The following program index term vectors on the vector table:</p>
<pre><code class="bash">sbt &quot;run-main com.getjenny.command.IndexTerms --inputfile terms.txt --vecsize 300&quot;
</code></pre>

<p>The format for each row of an input file with 5 dimension vectors is:
<code>hello 1.0 2.0 3.0 4.0 0.0</code></p>
<p>You can use your ad-hoc trained vector model (as we do) otherwise you can use the google word2vec models
trained on google news. You can find a copy of the <a href="https://raw.githubusercontent.com/GetJenny/jenny-public-data/master/elasticsearch.GoogleNewsVectors.tar.bz2">elasticsearch index with a pre-loaded google news terms</a>.</p>
<h1 id="test">Test</h1>
<h2 id="unit-tests">Unit tests</h2>
<p>A set of unit test is available using docker-compose to set up a backend, the command to run tests is:</p>
<pre><code class="bash">sbt dockerComposeUp ; sbt test ; sbt dockerComposeStop
</code></pre>

<h2 id="test-scripts-with-sample-api-calls">test scripts with sample API calls</h2>
<ul>
<li>A set of test script is present inside scripts/api_test</li>
</ul>
<h1 id="troubleshooting">Troubleshooting</h1>
<h2 id="docker-start-from-scratch">Docker: start from scratch</h2>
<p>You might want to start from scratch, and delete all docker images. </p>
<p>If you do so (<code>docker images</code> and then <code>docker rmi -f &lt;java/elasticsearch ids&gt;</code>) remember that all data for the 
Elasticsearch docker are local, and mounted only when the container is up. Therefore you need to:</p>
<pre><code class="bash">cd docker-starchat
rm -rf elasticsearch/data/nodes/
</code></pre>

<h2 id="docker-compose-analyzers-are-not-loaded">docker-compose: Analyzers are not loaded</h2>
<p>StarChat is started immediately after elasticsearch and it is possible that elasticsearch is
 not ready to respond to REST calls from StarChat (i.e. an index not found error could be
 raised in this case).</p>
<p>Sample error on the logs:</p>
<pre><code>2017-06-15 10:37:22,993 &gt;10:37:22.992UTC ERROR c.g.s.s.AnalyzerService(akka://starchat-service) com.getjenny.starchat.services.AnalyzerService(akka://starchat-service) - can't load analyzers: [jenny-en-0]
 IndexNotFoundException[no such index]
</code></pre>

<p>In order to avoid this problem you can call the services one by one:</p>
<pre><code class="bash">docker-compose up elasticsearch # here wait elasticsearch is up and running
docker-compose up starchat # starchat will retrieve the Analyzers from elasticsearch
</code></pre>

<p>In alternative is possible to call the command to load/refresh the Analyzers after the docker-compose command: </p>
<pre><code class="bash">curl -v -H &quot;Content-Type: application/json&quot; -X POST &quot;http://localhost:8888/decisiontable_analyzer&quot;
</code></pre>

<h2 id="docker-size-of-virtual-memory">Docker: Size of virtual memory</h2>
<p>If elasticsearch complain about the size of the virtual memory:</p>
<pre><code>max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]
elastisearch exited with code 78
</code></pre>

<p>run:</p>
<pre><code class="bash">sysctl -w vm.max_map_count=262144
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '.';</script>
        <script data-main="./mkdocs/js/search.js" src="./mkdocs/js/require.js"></script>
        <script src="./js/base.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>

<!--
MkDocs version : 0.16.3
Build Date UTC : 2018-06-18 14:49:26
-->
